<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seznam receptov</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container">
    <header>
        <h1>Seznam receptov</h1>
        <button id="addRecipeButton">Dodaj recept</button>
        <input type="text" id="searchInput" placeholder="Išči po naslovu" />
        <button id="searchButton">Išči</button>
    </header>

    <!-- Obrazec za dodajanje in urejanje recepta -->
    <div id="addRecipeForm" style="display: none;">
        <h2 id="formTitle">Dodaj nov recept</h2>
        <input type="text" id="naslov" placeholder="Naslov recepta" required>
        <input type="text" id="opis" placeholder="Opis recepta" required>
        <input type="text" id="sestavine" placeholder="Sestavine" required>
        <input type="text" id="navodila" placeholder="Navodila" required>
        <button id="submitRecipeButton">Shrani recept</button>
    </div>

    <ul id="recipe-list"></ul>
</div>

<script>
    let editingRecipeId = null; // To track the recipe being edited

    // Uporabite Fetch API za pridobivanje receptov
    function fetchRecipes(query = '') {
        const url = query ? `http://localhost:8080/api/recepti?query=${encodeURIComponent(query)}` : 'http://localhost:8080/api/recepti';

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const recipeList = document.getElementById('recipe-list');
                recipeList.innerHTML = ''; // Počisti seznam receptov
                data.forEach(recipe => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <div class="recipe-card">
                            <h2>${recipe.naslov}</h2>
                            <p>${recipe.opis}</p>
                            <button onclick="editRecipe(${recipe.id}, '${recipe.naslov}', '${recipe.opis}', '${recipe.sestavine}', '${recipe.navodila}')">Uredi</button>
                            <button onclick="deleteRecipe(${recipe.id})">Izbriši</button>
                        </div>
                    `;
                    recipeList.appendChild(listItem);
                });
            })
            .catch(error => {
                console.error("Napaka pri pridobivanju receptov:", error);
            });
    }

    // Dodaj recept
    document.getElementById("addRecipeButton").addEventListener("click", () => {
        const form = document.getElementById("addRecipeForm");
        form.style.display = form.style.display === "none" ? "block" : "none"; // Prikaži/skrij obrazec
        clearForm(); // Počisti obrazec ob prikazu
    });

    // Shrani ali posodobi recept
    document.getElementById("submitRecipeButton").addEventListener("click", () => {
        const recept = {
            naslov: document.getElementById("naslov").value,
            opis: document.getElementById("opis").value,
            sestavine: document.getElementById("sestavine").value,
            navodila: document.getElementById("navodila").value
        };

        // Preverite, ali so vsa polja izpolnjena
        if (!recept.naslov || !recept.opis || !recept.sestavine || !recept.navodila) {
            alert("Vsa polja so obvezna.");
            return;
        }

        // Check if we are editing an existing recipe
        if (editingRecipeId) {
            updateRecipe(editingRecipeId, recept);
        } else {
            fetch('http://localhost:8080/api/recepti', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(recept)
            })
                .then(response => {
                    if (response.ok) {
                        fetchRecipes(); // Osveži seznam receptov
                        document.getElementById("addRecipeForm").style.display = "none"; // Skrij obrazec
                        clearForm(); // Počisti obrazec
                    } else {
                        console.error("Napaka pri dodajanju recepta:", response.statusText);
                        alert("Napaka pri dodajanju recepta. Poskusite znova.");
                    }
                })
                .catch(error => {
                    console.error("Napaka:", error);
                    alert("Napaka pri komunikaciji s strežnikom.");
                });
        }
    });

    // Iskanje receptov po naslovu
    document.getElementById("searchButton").addEventListener("click", () => {
        const query = document.getElementById("searchInput").value.trim();
        fetchRecipes(query); // Pokličite fetchRecipes z iskalnim nizom
    });

    // Uredi recept
    function editRecipe(id, naslov, opis, sestavine, navodila) {
        document.getElementById("naslov").value = naslov;
        document.getElementById("opis").value = opis;
        document.getElementById("sestavine").value = sestavine;
        document.getElementById("navodila").value = navodila;

        // Prikaži obrazec in spremeni gumb za shrani
        document.getElementById("addRecipeForm").style.display = "block";
        document.getElementById("submitRecipeButton").innerText = "Posodobi recept";

        // Set the editing ID
        editingRecipeId = id; // Save the ID of the recipe being edited
    }

    // Posodobi recept
    function updateRecipe(id, recept) {
        fetch(`http://localhost:8080/api/recepti/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(recept)
        })
            .then(response => {
                if (response.ok) {
                    fetchRecipes(); // Osveži seznam receptov
                    document.getElementById("addRecipeForm").style.display = "none"; // Skrij obrazec
                    clearForm(); // Počisti obrazec
                    editingRecipeId = null; // Reset the editing ID
                } else {
                    console.error("Napaka pri posodabljanju recepta:", response.statusText);
                    alert("Napaka pri posodabljanju recepta. Poskusite znova.");
                }
            })
            .catch(error => {
                console.error("Napaka:", error);
                alert("Napaka pri komunikaciji s strežnikom.");
            });
    }

    // Izbriši recept
    function deleteRecipe(id) {
        if (confirm("Ali ste prepričani, da želite izbrisati ta recept?")) {
            fetch(`http://localhost:8080/api/recepti/${id}`, {
                method: 'DELETE'
            })
                .then(response => {
                    if (response.ok) {
                        fetchRecipes(); // Osveži seznam receptov
                    } else {
                        console.error("Napaka pri brisanju recepta:", response.statusText);
                        alert("Napaka pri brisanju recepta. Poskusite znova.");
                    }
                })
                .catch(error => {
                    console.error("Napaka:", error);
                    alert("Napaka pri komunikaciji s strežnikom.");
                });
        }
    }

    // Funkcija za čiščenje obrazca
    function clearForm() {
        document.getElementById("naslov").value = '';
        document.getElementById("opis").value = '';
        document.getElementById("sestavine").value = '';
        document.getElementById("navodila").value = '';
        document.getElementById("submitRecipeButton").innerText = "Shrani recept"; // Resetiraj gumb
        editingRecipeId = null; // Reset the editing ID
    }

    // Pridobi recepte ob nalaganju strani
    window.onload = fetchRecipes;
</script>
</body>
</html>
